import "pe"
import "math"

rule Ransomware_DLL_Imports {
    meta:
        description = "Detects DLLs often used in ransomware operations"
        author = "CipherStrike"
        severity = "medium"
        score = 55
    
    strings:
        // Add WinInet as a string pattern instead of using imports_regex
        $wininet = "WinInet.dll" nocase
        
    condition:
        uint16(0) == 0x5A4D and
        pe.is_pe and
        (
            pe.imports("advapi32.dll", "CryptEncrypt") or
            pe.imports("advapi32.dll", "CryptAcquireContext") or
            pe.imports("advapi32.dll", "CryptGenKey") or
            pe.imports("advapi32.dll", "CryptDeriveKey") or
            pe.imports("crypt32.dll", "CryptProtectData") or
            pe.imports("bcrypt.dll", "BCryptEncrypt") or
            pe.imports("bcrypt.dll", "BCryptGenRandom") or
            (
                pe.imports("kernel32.dll", "CreateFile") and
                pe.imports("kernel32.dll", "WriteFile") and
                pe.imports("kernel32.dll", "ReadFile") and
                $wininet  // Use the string pattern instead
            )
        )
}

rule Ransomware_Suspicious_API_Calls {
    meta:
        description = "Detects suspicious API function combinations used in ransomware"
        author = "CipherStrike"
        severity = "low"
        score = 15
    
    strings:
        $api1 = "CryptEncrypt" nocase
        $api2 = "WriteProcessMemory" nocase
        $api3 = "VirtualAlloc" nocase
        $api4 = "VirtualProtect" nocase
        $api5 = "DeleteFile" nocase
        $api6 = "FindFirstFile" nocase
        $api8 = "ShellExecute" nocase
        $api9 = "WinExec" nocase
        $api10 = "CreateFile" nocase
        $api11 = "ReadFile" nocase
        $api12 = "WriteFile" nocase
        
    condition:
        uint16(0) == 0x5A4D and 
        (
            (3 of ($api1, $api5, $api6, $api10, $api11, $api12)) or   // File encryption pattern
            (3 of ($api2, $api3, $api4, $api8, $api9))                // Process manipulation pattern
        )
}

rule Ransomware_Registry_Operations {
    meta:
        description = "Detects registry operations commonly performed by ransomware"
        author = "CipherStrike"
        severity = "low"
        score = 15
    
    strings:
        $reg1 = "RegSetValue" nocase
        $reg2 = "RegCreateKey" nocase
        $reg3 = "RegOpenKeyEx" nocase
        $reg4 = "RegDeleteKey" nocase
        $reg5 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg6 = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg7 = "SYSTEM\\CurrentControlSet" nocase

    condition:
        uint16(0) == 0x5A4D and 
        (
            2 of ($reg1, $reg2, $reg3, $reg4) or
            any of ($reg5, $reg6, $reg7)
        )
}

rule Ransomware_File_Drive_Access {
    meta:
        description = "Detects mass file access or operations on drives"
        author = "CipherStrike"
        severity = "low"
        score = 10
    
    strings:
        $fileapi1 = "FindFirstFile" nocase
        $fileapi2 = "FindNextFile" nocase
        $fileapi3 = "SetFileAttributes" nocase
        $driveapi1 = "GetLogicalDrives" nocase
        $driveapi2 = "GetDriveType" nocase
        $file_ext1 = ".doc" nocase
        $file_ext2 = ".pdf" nocase
        $file_ext3 = ".jpg" nocase
        $file_ext4 = ".png" nocase
        $file_ext5 = ".txt" nocase
        $file_ext6 = ".zip" nocase
        $file_op1 = "CreateFile" nocase
        $file_op2 = "ReadFile" nocase
        $file_op3 = "WriteFile" nocase
    
    condition:
        uint16(0) == 0x5A4D and 
        (
            // Mass file enumeration pattern
            (all of ($fileapi*) and 2 of ($driveapi*)) or
            // Common file extensions accessed together (ransomware searching for files)
            (4 of ($file_ext*) and 2 of ($fileapi*)) or
            // File operation pattern
            (all of ($file_op*) and any of ($fileapi*))
        )
}

rule Ransomware_Crypto_Usage {
    meta:
        description = "Detects usage of cryptographic algorithms and functions"
        author = "CipherStrike"
        severity = "high"
        score = 75
    
    strings:
        // Crypto APIs
        $crypto1 = "CryptEncrypt" nocase
        $crypto2 = "CryptDecrypt" nocase
        $crypto3 = "BCryptEncrypt" nocase
        $crypto4 = "BCryptDecrypt" nocase
        
        // Common crypto constants and algorithms
        $aes_sbox = { 63 7C 77 7B F2 6B 6F C5 30 01 67 2B FE D7 AB 76 }
        $aes_const = { 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F }
        $rsa = "RSA1" ascii
        $rsa2 = "rsaEncrypt" nocase
        $rsa3 = "rsaDecrypt" nocase
        
        // Crypto libraries
        $openssl = "OpenSSL" ascii wide
        $crypto_lib = "libcrypto" ascii wide
        $crypto_plus = "Crypto++" ascii wide
        $botan = "Botan" ascii wide
    
    condition:
        uint16(0) == 0x5A4D and 
        (
            // Direct API usage
            2 of ($crypto*) or
            // AES implementation
            any of ($aes*) or
            // RSA usage
            any of ($rsa*) or
            // Crypto libraries
            any of ($openssl, $crypto_lib, $crypto_plus, $botan)
        )
}

rule Ransomware_String_Indicators {
    meta:
        description = "Detects strings commonly found in ransomware"
        author = "CipherStrike"
        severity = "critical"
        score = 80
    
    strings:
        // Ransom notes
        $note1 = "your files have been encrypted" nocase ascii wide
        $note2 = "pay the ransom" nocase ascii wide
        $note3 = "bitcoin address" nocase ascii wide
        $note4 = "decrypt your files" nocase ascii wide
        $note5 = "your important files encryption produced" nocase ascii wide
        $note6 = "your documents, photos, databases and other" nocase ascii wide
        $note7 = "README.txt" fullword ascii wide
        $note8 = "HOW_TO_DECRYPT" ascii wide
        $note9 = "RECOVERY_" ascii wide

        // Bitcoin/cryptocurrency
        $btc1 = "bitcoin" nocase ascii wide
        $btc2 = "BTC" fullword ascii
        $btc4 = "wallet" nocase ascii wide
        $btc5 = "payment" nocase ascii wide
        
        // TOR/Anonymity
        $tor1 = ".onion" ascii wide
        $tor2 = "tor browser" nocase ascii wide
        $tor3 = "torbrowser" nocase ascii wide
        
        
    condition:
        uint16(0) == 0x5A4D and 
        (
            2 of ($note*) or
            (any of ($note*) and any of ($btc*, $tor*)) or
            (any of ($btc*) and any of ($tor*)) or
            (any of ($note*, $btc*, $tor*))
        )
}

rule Suspicious_Encoded_Data_And_URLS {
    meta:
        description = "Detects Base64 encoded data and suspicious URLs/IPs"
        author = "CipherStrike"
        severity = "low"
        score = 10
    
    strings:
        // Base64/encoded data
        $base64 = /[A-Za-z0-9+\/]{50,}={0,2}/
        
        // C2 URLs/IPs
        $url = /https?:\/\/[a-zA-Z0-9\.\-\_]{5,50}/ ascii wide
        $ip = /http:\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/
    
    condition:
        uint16(0) == 0x5A4D and 
        (
            $base64 or
            $url or
            $ip
        )
}
rule Ransomware_Anti_Debug_Evasion {
    meta:
        description = "Detects anti-debugging and evasion techniques"
        author = "CipherStrike"
        severity = "low"
        score = 20
    
    strings:
        // Anti-debug techniques
        $debug1 = "IsDebuggerPresent" nocase
        $debug2 = "CheckRemoteDebuggerPresent" nocase
        $debug3 = "OutputDebugString" nocase
        $debug4 = "FindWindow" nocase
        $debug5 = "GetTickCount" nocase
        
        // VM detection
        $vm1 = "VMware" nocase
        $vm2 = "VBox" nocase
        $vm3 = "QEMU" nocase
        $vm4 = "VBOX" nocase
        $vm5 = "VIRTUAL" nocase
        
      
        // Sandbox evasion
        $sandbox1 = "username" nocase
        $sandbox2 = "currentuser" nocase
        $sandbox3 = "mouse_event" nocase
        $sandbox4 = "GetCursorPos" nocase
    
    condition:
        uint16(0) == 0x5A4D and 
        (
            2 of ($debug*) or
            2 of ($vm*) or
            ( any of ($debug*, $vm*)) or
            3 of ($sandbox*)
        )
}

rule Ransomware_PE_Sections {
    meta:
        description = "Detects unusual PE section names often found in ransomware"
        author = "CipherStrike"
        severity = "medium"
        score = 40
    
    condition:
        uint16(0) == 0x5A4D and
        pe.is_pe and
        for any i in (0..pe.number_of_sections-1): (
            pe.sections[i].name matches /\.(fun|xxx|evil|enc|lock|crypted|2dec|enc|krab)/ or
            pe.sections[i].name matches /UPX[0-9]/ or
            pe.sections[i].name matches /\.adata/
            // Entropy check removed - covered by Ransomware_High_Entropy rule
        )
}

rule Ransomware_High_Entropy {
    meta:
        description = "Detects files with high entropy which may indicate packing or encryption"
        author = "CipherStrike"
        severity = "medium"
        score = 35
    
    condition:
        uint16(0) == 0x5A4D and
        math.entropy(0, filesize) > 8.5
}

rule Ransomware_Hardcoded_Commands {
    meta:
        description = "Detects hardcoded commands used for sabotaging recovery options"
        author = "CipherStrike"
        severity = "critical"
        score = 85
    
    strings:
        // Shadow copy deletion
        $cmd1 = "vssadmin delete shadows" nocase ascii wide
        $cmd2 = "wmic shadowcopy delete" nocase ascii wide
        
        // Recovery disabling
        $cmd3 = "bcdedit /set {default} recoveryenabled no" nocase ascii wide
        $cmd4 = "bcdedit /set {default} bootstatuspolicy ignoreallfailures" nocase ascii wide
        
        // Backup deletion
        $cmd5 = "wbadmin delete catalog" nocase ascii wide
        $cmd6 = "wbadmin delete systemstatebackup" nocase ascii wide
        
        // Service stopping
        $cmd7 = "net stop" nocase ascii wide
        $serv1 = "SQLWriter" nocase ascii wide
        $serv2 = "wmiApSrv" nocase ascii wide
        $serv3 = "MSSQL" nocase ascii wide
        $serv4 = "sophos" nocase ascii wide
        $serv5 = "veeam" nocase ascii wide
        $serv6 = "backup" nocase ascii wide
        $serv7 = "AV" nocase ascii wide
        
        // Task killing
        $cmd8 = "taskkill" nocase ascii wide
        $proc1 = "sqlservr.exe" nocase ascii wide
        $proc2 = "oracle.exe" nocase ascii wide
        $proc3 = "ocssd.exe" nocase ascii wide
        $proc4 = "dbsnmp.exe" nocase ascii wide
        $proc5 = "synctime.exe" nocase ascii wide
        $proc6 = "agntsvc.exe" nocase ascii wide
        $proc7 = "isqlplussvc.exe" nocase ascii wide
        $proc8 = "xfssvccon.exe" nocase ascii wide
    
    condition:
        uint16(0) == 0x5A4D and 
        (
            any of ($cmd1, $cmd2) or                               // Shadow copy commands
            any of ($cmd3, $cmd4) or                               // Recovery commands
            any of ($cmd5, $cmd6) or                               // Backup deletion
            ($cmd7 and 2 of ($serv*)) or                           // Service stopping
            ($cmd8 and 2 of ($proc*)) or                           // Process killing
            (any of ($cmd*) and any of ($serv*, $proc*))           // Combination
        )
}

global rule Ransomware_Classification {
    meta:
        description = "Classifies a file as ransomware based on weighted rule matches"
        author = "CipherStrike"
        severity = "critical"
        score = 0
        ransomware_probability = "Calculated at runtime"
    
    condition:
        uint16(0) == 0x5A4D and
        (
            // Critical indicators - high confidence if any of these match
            (
                Ransomware_Hardcoded_Commands or 
                Ransomware_String_Indicators
            ) or

            // Strong indicators - high confidence with combinations
            (
                Ransomware_Crypto_Usage and 
                (Ransomware_File_Drive_Access or Ransomware_DLL_Imports)
            ) or

            // Multiple suspicious behaviors - medium-high confidence
            (
                Ransomware_Suspicious_API_Calls and
                Ransomware_Registry_Operations and
                (Ransomware_High_Entropy or Ransomware_PE_Sections)
            ) or
            
            // Several lower-confidence indicators together
            (
                3 of (
                    Ransomware_DLL_Imports,
                    Ransomware_Registry_Operations,
                    Ransomware_File_Drive_Access,
                    Ransomware_Anti_Debug_Evasion,
                    Ransomware_PE_Sections,
                    Ransomware_High_Entropy
                )
            )
        )
}