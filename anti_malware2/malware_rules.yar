rule SuspiciousStrings {
    meta:
        description = "Detects suspicious strings often found in malware"
        author = "CipherStrike"
        severity = "medium"
        score = 60
    
    strings:
        $cmd1 = "cmd.exe" nocase
        $cmd2 = "powershell" nocase
        $registry = "RegCreateKeyEx" nocase
        $download = "URLDownloadToFile" nocase
        $injection = "VirtualAlloc" nocase
        $hidden = "hidden" nocase

    condition:
        uint16(0) == 0x5A4D and 3 of them
}

rule PotentialPacker {
    meta:
        description = "Detects potential packing indicators"
        author = "CipherStrike"
        severity = "medium"
        score = 50
    
    strings:
        $upx = "UPX" ascii
        $aspack = "ASPack" ascii
        $pecompact = "PECompact" ascii

    condition:
        uint16(0) == 0x5A4D and any of them
}

rule SuspiciousFunctions {
    meta:
        description = "Detects suspicious API function combinations"
        author = "CipherStrike"
        severity = "high"
        score = 75
    
    strings:
        $create_process = "CreateProcess" nocase
        $create_remote_thread = "CreateRemoteThread" nocase
        $virtual_alloc = "VirtualAlloc" nocase
        $write_process_memory = "WriteProcessMemory" nocase
        
    condition:
        uint16(0) == 0x5A4D and 3 of them
}

rule CryptographicActivity {
    meta:
        description = "Detects cryptographic libraries and functions commonly used in ransomware"
        author = "CipherStrike"
        severity = "medium"
        score = 65
    
    strings:
        // Windows Crypto API
        $cryptoapi1 = "advapi32.dll" nocase
        $cryptoapi2 = "crypt32.dll" nocase
        $cryptoapi3 = "bcrypt.dll" nocase
        
        // Crypto functions
        $func1 = "CryptEncrypt" nocase
        $func2 = "CryptDecrypt" nocase
        $func3 = "CryptGenKey" nocase
        $func4 = "CryptHashData" nocase
        $func5 = "CryptDeriveKey" nocase
        
        // Common crypto libraries
        $lib1 = "OpenSSL" nocase
        $lib2 = "libcrypto" nocase
        $lib3 = "Crypto++" nocase
        
        // Encryption algorithms
        $alg1 = "AES" fullword ascii
        $alg2 = "RSA" fullword ascii
        $alg3 = "Blowfish" nocase
        $alg4 = "RC4" fullword ascii
        
        // Ransomware-related strings
        $ransom1 = "encrypt" nocase
        $ransom2 = ".locked" nocase
        $ransom3 = "decrypt" nocase
        $ransom4 = "bitcoin" nocase
        $ransom5 = "ransom" nocase

    condition:
        uint16(0) == 0x5A4D and 
        (
            // High probability of crypto activity
            (2 of ($cryptoapi*) and 2 of ($func*)) or
            // Suspicious combination of crypto libraries and algorithms
            (any of ($lib*) and 2 of ($alg*)) or
            // Potential ransomware indicators
            (3 of ($ransom*) and any of ($func*)) or
            // Multiple crypto functions
            (4 of ($func*))
        )
}