import os
import yara

def compile_yara_rules(rule_file):
    """
    Compiles YARA rules from a file.

    Args:
        rule_file (str): Path to the YARA rule file.

    Returns:
        yara.Rules: Compiled YARA rules.
    """
    try:
        rules = yara.compile(filepath=rule_file)
        return rules
    except yara.SyntaxError as e:
        print(f"Error compiling YARA rules: {e}")
        return None

def scan_file_with_yara(rules, file_path):
    """
    Scans a file using YARA rules and calculates a total score.

    Args:
        rules (yara.Rules): Compiled YARA rules.
        file_path (str): Path to the file to scan.

    Returns:
        tuple: Total score and a list of matched rules.
    """
    try:
        matches = rules.match(file_path)
        total_score = 0
        matched_rules = []

        for match in matches:
            score = int(match.meta.get("score", 0))  # Get the score from the rule's metadata
            total_score += score
            matched_rules.append((match.rule, score, match.meta.get("category", "Unknown")))

        return total_score, matched_rules
    except Exception as e:
        print(f"Error scanning file {file_path}: {e}")
        return 0, []

def list_exe_files(directory):
    """
    Lists all .exe files in the specified directory.

    Args:
        directory (str): The directory to scan for .exe files.

    Returns:
        list: A list of .exe file paths.
    """
    return [os.path.join(directory, f) for f in os.listdir(directory) if f.endswith(".exe")]

def main():
    # Path to the YARA rule file
    yara_rule_file = "ransomware_rules.yar"

    # Compile YARA rules
    rules = compile_yara_rules(yara_rule_file)
    if not rules:
        print("Failed to compile YARA rules. Exiting.")
        return

    # Get the directory where the script is located
    base_dir = os.path.dirname(os.path.abspath(__file__))

    # List all .exe files in the directory
    exe_files = list_exe_files(base_dir)

    # Define a threshold score for flagging ransomware
    threshold_score = 30

    if exe_files:
        print("Scanning .exe files with YARA...")
        for exe in exe_files:
            total_score, matched_rules = scan_file_with_yara(rules, exe)

            print(f"\nFile: {exe}")
            print(f"Total Score: {total_score}")
            if matched_rules:
                print("Matched Rules:")
                for rule, score, category in matched_rules:
                    print(f" - Rule: {rule}, Score: {score}, Category: {category}")

            if total_score >= threshold_score:
                print("Result: Suspicious (Potential Ransomware)")
            else:
                print("Result: Benign")
    else:
        print("No .exe files found in the directory.")

if __name__ == "__main__":
    main()


import math

def calculate_entropy(file_path):
    with open(file_path, "rb") as f:
        data = f.read()
    if not data:
        return 0
    byte_counts = [0] * 256
    for byte in data:
        byte_counts[byte] += 1
    entropy = -sum((count / len(data)) * math.log2(count / len(data)) for count in byte_counts if count > 0)
    return entropy

# Example usage
entropy = calculate_entropy("example.exe")
print(f"Entropy: {entropy}")    