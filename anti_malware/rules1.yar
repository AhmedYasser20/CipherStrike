/*
 * Ransomware Detection Rules
 * Based on static analysis signatures of ransomware characteristics
 */

rule Ransomware_Suspicious_Imports {
    meta:
        description = "Detects executables with suspicious combination of crypto and filesystem imports"
        author = "Security Analyst"
        severity = "medium"
    
    strings:
        // Crypto DLLs
        $crypto_dll1 = "bcrypt.dll" nocase ascii wide
        $crypto_dll2 = "ncrypt.dll" nocase ascii wide
        $crypto_dll3 = "crypt32.dll" nocase ascii wide
        $crypto_dll4 = "advapi32.dll" nocase ascii wide
        $crypto_dll5 = "wincrypt.h" nocase ascii wide
        
        // File System Enumeration
        $fs_dll1 = "kernel32.dll" nocase ascii wide
        $fs_dll2 = "shell32.dll" nocase ascii wide
        $fs_dll3 = "shlwapi.dll" nocase ascii wide
        $fs_dll4 = "ntdll.dll" nocase ascii wide
        
        // Internet Requests
        $net_dll1 = "wininet.dll" nocase ascii wide
        $net_dll2 = "winhttp.dll" nocase ascii wide
        $net_dll3 = "ws2_32.dll" nocase ascii wide
        $net_dll4 = "urlmon.dll" nocase ascii wide
        $net_dll5 = "dnsapi.dll" nocase ascii wide
        $net_dll6 = "httpapi.dll" nocase ascii wide
    
    condition:
        uint16(0) == 0x5A4D and // MZ header
        (
            // At least 2 crypto DLLs + 2 filesystem DLLs
            (2 of ($crypto_dll*) and 2 of ($fs_dll*)) or
            // Or crypto + filesystem + network (C2 communication)
            (1 of ($crypto_dll*) and 1 of ($fs_dll*) and 1 of ($net_dll*))
        )
}

rule Ransomware_Suspicious_Functions {
    meta:
        description = "Detects executables with suspicious encryption and filesystem functions"
        author = "Security Analyst"
        severity = "high"
    
    strings:
        // File enumeration
        $enum1 = "FindFirstFile" ascii wide
        $enum2 = "FindNextFile" ascii wide
        $enum3 = "FindClose" ascii wide
        $enum4 = "GetLogicalDrives" ascii wide
        $enum5 = "GetDriveType" ascii wide
        
        // File operations
        $file1 = "CreateFile" ascii wide
        $file2 = "ReadFile" ascii wide
        $file3 = "WriteFile" ascii wide
        $file4 = "DeleteFile" ascii wide
        $file5 = "RemoveDirectory" ascii wide
        $file6 = "SetFileAttributes" ascii wide
        
        // Crypto functions
        $crypt1 = "CryptAcquireContext" ascii wide
        $crypt2 = "CryptGenKey" ascii wide
        $crypt3 = "CryptEncrypt" ascii wide
        $crypt4 = "CryptDecrypt" ascii wide
        $crypt5 = "BCryptEncrypt" ascii wide
        $crypt6 = "BCryptGenRandom" ascii wide
        
        // Network functions
        $net1 = "InternetOpen" ascii wide
        $net2 = "InternetConnect" ascii wide
        $net3 = "HttpOpenRequest" ascii wide
        $net4 = "HttpSendRequest" ascii wide
        $net5 = "WinHttpOpen" ascii wide
        $net6 = "socket" ascii wide
        $net7 = "connect" ascii wide
        $net8 = "send" ascii wide
        $net9 = "recv" ascii wide
        
        // Anti-analysis functions
        $anti1 = "IsDebuggerPresent" ascii wide
        $anti2 = "CheckRemoteDebuggerPresent" ascii wide
        $anti3 = "NtQueryInformationProcess" ascii wide
        $anti4 = "GetTickCount" ascii wide
        $anti5 = "QueryPerformanceCounter" ascii wide
        $anti6 = "Sleep" ascii wide
        
        // System modification
        $sys1 = "RegOpenKey" ascii wide
        $sys2 = "RegSetValue" ascii wide
        $sys3 = "RegCreateKey" ascii wide
        $sys4 = "CreateService" ascii wide
        $sys5 = "OpenService" ascii wide
        $sys6 = "StartService" ascii wide
        
        // Privilege escalation and evasion
        $priv1 = "AdjustTokenPrivileges" ascii wide
        $priv2 = "OpenProcessToken" ascii wide
        $priv3 = "VirtualAlloc" ascii wide
        $priv4 = "VirtualAllocEx" ascii wide
        $priv5 = "WriteProcessMemory" ascii wide
        $priv6 = "ReadProcessMemory" ascii wide
        $priv7 = "CreateRemoteThread" ascii wide
    
    condition:
        uint16(0) == 0x5A4D and // MZ header
        (
            // File enumeration + file operations + crypto
            (2 of ($enum*) and 2 of ($file*) and 2 of ($crypt*)) or
            // File operations + crypto + anti-analysis
            (2 of ($file*) and 2 of ($crypt*) and 1 of ($anti*)) or
            // File operations + crypto + system modification
            (2 of ($file*) and 2 of ($crypt*) and 1 of ($sys*)) or
            // File operations + crypto + network
            (2 of ($file*) and 2 of ($crypt*) and 1 of ($net*)) or
            // Privilege escalation functions
            (1 of ($priv*) and 2 of ($file*) and 1 of ($crypt*))
        )
}

rule Ransomware_Suspicious_Strings {
    meta:
        description = "Detects executables with ransomware-related strings"
        author = "Security Analyst"
        severity = "high"
    
    strings:
        // Ransom note words
        $note1 = "encrypted" nocase ascii wide
        $note2 = "decrypt" nocase ascii wide
        $note3 = "bitcoin" nocase ascii wide
        $note4 = "payment" nocase ascii wide
        $note5 = "pay" nocase ascii wide
        $note6 = "ransom" nocase ascii wide
        $note7 = "files" nocase ascii wide
        $note8 = "hours" nocase ascii wide
        $note9 = "before" nocase ascii wide
        $note10 = "delete" nocase ascii wide
        $note11 = "forever" nocase ascii wide
        $note12 = "recover" nocase ascii wide
        $note13 = "wallet" nocase ascii wide
        $note14 = "btc" nocase ascii wide
        $note15 = "monero" nocase ascii wide
        $note16 = "xmr" nocase ascii wide
        
        // Suspicious file extensions
        $ext1 = ".encrypted" nocase ascii wide
        $ext2 = ".locked" nocase ascii wide
        $ext3 = ".crypt" nocase ascii wide
        $ext4 = ".payforunlock" nocase ascii wide
        $ext5 = ".fun" nocase ascii wide
        $ext6 = ".pay" nocase ascii wide
        $ext7 = ".crypto" nocase ascii wide
        $ext8 = ".ransom" nocase ascii wide
        $ext9 = ".enc" nocase ascii wide
        
        // Multiple standard file extensions (target files)
        $target1 = ".txt" nocase ascii wide
        $target2 = ".doc" nocase ascii wide
        $target3 = ".docx" nocase ascii wide
        $target4 = ".xls" nocase ascii wide
        $target5 = ".xlsx" nocase ascii wide
        $target6 = ".pdf" nocase ascii wide
        $target7 = ".jpg" nocase ascii wide
        $target8 = ".jpeg" nocase ascii wide
        $target9 = ".png" nocase ascii wide
        $target10 = ".zip" nocase ascii wide
        $target11 = ".rar" nocase ascii wide
        $target12 = ".csv" nocase ascii wide
        $target13 = ".ppt" nocase ascii wide
        $target14 = ".pptx" nocase ascii wide
        
        // Anti-recovery commands
        $cmd1 = "vssadmin delete shadows" nocase ascii wide
        $cmd2 = "bcdedit /set {default} recoveryenabled no" nocase ascii wide
        $cmd3 = "wbadmin delete catalog" nocase ascii wide
        $cmd4 = "wmic shadowcopy delete" nocase ascii wide
        $cmd5 = "cipher /w" nocase ascii wide
    
    condition:
        uint16(0) == 0x5A4D and // MZ header
        (
            // At least 3 ransom note words + file extensions
            (3 of ($note*) and 6 of ($target*)) or
            // Suspicious extensions + target extensions
            (1 of ($ext*) and 6 of ($target*)) or
            // Any anti-recovery command + target extensions
            (1 of ($cmd*) and 6 of ($target*)) or
            // Any anti-recovery command + ransom note words
            (1 of ($cmd*) and 3 of ($note*))
        )
}

rule Ransomware_Behaviors_Combined {
    meta:
        description = "Comprehensive rule combining multiple ransomware indicators"
        author = "Security Analyst"
        severity = "critical"
    
    condition:
        uint16(0) == 0x5A4D and // MZ header
        (
            // At least two of our specialized rules
            2 of (
                Ransomware_Suspicious_Imports,
                Ransomware_Suspicious_Functions,
                Ransomware_Suspicious_Strings
            )
        )
}