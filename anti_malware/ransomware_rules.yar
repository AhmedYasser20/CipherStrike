rule Detect_Crypto_DLLs {
    meta:
        description = "Detects suspicious DLLs used for cryptographic operations"
        author = "M4 Ahmed"
        category = "Ransomware"
        score = 20
    strings:
        $bcrypt = "bcrypt.dll"
        $ncrypt = "ncrypt.dll"
        $crypt32 = "crypt32.dll"
        $wincrypt = "wincrypt.h"
        $Rundll32 = "Rundll32.exe"
        $advapi32 = "advapi32.dll"
    condition:
        any of them
}

rule Detect_FileSystem_DLLs {
    meta:
        description = "Detects suspicious DLLs used for file system operations"
        author = "M4 Ahmed"
        category = "Ransomware"
    strings:
        $kernel32 = "kernel32.dll"
        $shell32 = "shell32.dll"
        $shlwapi = "shlwapi.dll"
        $ntdll = "ntdll.dll"
        $ole32 = "ole32.dll"
    condition:
        any of them
}

rule Detect_Internet_DLLs {
    meta:
        description = "Detects suspicious DLLs used for internet requests"
        author = "M4 Ahmed"
        category = "Ransomware"
    strings:
        $wininet = "wininet.dll"
        $winhttp = "winhttp.dll"
        $ws2_32 = "ws2_32.dll"
        $urlmon = "urlmon.dll"
        $httpapi = "httpapi.dll"
        $dnsapi = "dnsapi.dll"
    condition:
        any of them
}

rule Detect_Suspicious_Functions {
    meta:
        description = "Detects suspicious functions commonly used by ransomware"
        author = "M4 Ahmed"
        category = "Ransomware"
    strings:
        // Dynamic Loading
        $load_library = "LoadLibrary"
        $get_proc_address = "GetProcAddress"

        // File Enumeration and Manipulation
        $find_first_file = "FindFirstFile"
        $find_next_file = "FindNextFile"
        $find_close = "FindClose"
        $create_file = "CreateFile"
        $read_file = "ReadFile"
        $write_file = "WriteFile"
        $delete_file = "DeleteFile"
        $remove_directory = "RemoveDirectory"
        $set_file_attributes = "SetFileAttributes"
        $get_logical_drives = "GetLogicalDrives"
        $get_drive_type = "GetDriveType"

        // Cryptographic Operations
        $crypt_acquire_context = "CryptAcquireContext"
        $crypt_gen_key = "CryptGenKey"
        $crypt_encrypt = "CryptEncrypt"
        $crypt_decrypt = "CryptDecrypt"
        $bcrypt_encrypt = "BCryptEncrypt"
        $bcrypt_gen_random = "BCryptGenRandom"

        // Network Communication
        $internet_open = "InternetOpen"
        $internet_connect = "InternetConnect"
        $http_open_request = "HttpOpenRequest"
        $http_send_request = "HttpSendRequest"
        $winhttp_open = "WinHttpOpen"
        $winhttp_connect = "WinHttpConnect"
        $winhttp_send_request = "WinHttpSendRequest"
        $socket = "socket"
        $connect = "connect"
        $send = "send"
        $recv = "recv"
        $url_download_to_file = "URLDownloadToFile"

        // Process and Memory Manipulation
        $open_process = "OpenProcess"
        $virtual_alloc = "VirtualAlloc"
        $virtual_alloc_ex = "VirtualAllocEx"
        $write_process_memory = "WriteProcessMemory"
        $read_process_memory = "ReadProcessMemory"
        $create_remote_thread = "CreateRemoteThread"
        $adjust_token_privileges = "AdjustTokenPrivileges"
        $open_process_token = "OpenProcessToken"

        // Anti-Debugging and Sandbox Evasion
        $is_debugger_present = "IsDebuggerPresent"
        $check_remote_debugger_present = "CheckRemoteDebuggerPresent"
        $nt_query_information_process = "NtQueryInformationProcess"
        $sleep = "Sleep"
        $get_tick_count = "GetTickCount"
        $query_performance_counter = "QueryPerformanceCounter"
        $rdtsc = "RDTSC"
        $nt_delay_execution = "NtDelayExecution"

        // Registry Manipulation
        $reg_open_key = "RegOpenKey"
        $reg_set_value = "RegSetValue"
        $reg_create_key = "RegCreateKey"

        // Service Manipulation
        $create_service = "CreateService"
        $open_service = "OpenService"
        $start_service = "StartService"

        // Persistence and Execution
        $copy_file = "CopyFile"
        $system = "system"
        $shell_execute = "ShellExecute"
        $create_process = "CreateProcess"
        $delete_volume_mount_point = "DeleteVolumeMountPoint"

        // Disk Manipulation
        $device_io_control = "DeviceIoControl"

    condition:
        any of them
}

rule Specific_Ransomware {
    meta:
        description = "Detects a specific ransomware family"
        author = "M4 Ahmed"
        category = "Ransomware"
    strings:
        $ransom_note = "Your files have been encrypted"
        $encryption_key = { 01 23 45 67 89 AB CD EF }
    condition:
        any of them
}


//Need to Check
rule Detect_Weird_Section_Names {
    meta:
        description = "Detects executables with non-standard or suspicious section names"
        author = "M4 Ahmed"
        category = "Ransomware"
        score = 15
    strings:
        // Known standard section names
        $text = ".text"
        $rdata = ".rdata"
        $edata = ".edata"
        $tls = ".tls"
        $data = ".data"
        $rodata = ".rodata"
        $rsrc = ".rsrc"
        $pdata = ".pdata"
        $bss = ".bss"
        $idata = ".idata"
        $reloc = ".reloc"
        $crt = ".CRT"
    condition:
        // Match any section name that is NOT in the known list
        for any of ($text, $rdata, $edata, $tls, $data, $rodata, $rsrc, $pdata, $bss, $idata, $reloc, $crt): (not $)
}



rule Detect_Hardcoded_IPs_And_URLs {
    meta:
        description = "Detects hardcoded IP addresses or URLs in executables"
        author = "M4 Ahmed"
        category = "Ransomware"
        score = 20
    strings:
        $ip_pattern = /(\d{1,3}\.){3}\d{1,3}/  // Matches IPv4 addresses
        $http = "http://"
        $https = "https://"
        $url_pattern = /[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}/  // Matches domain names
    condition:
        any of them
}

rule Detect_Ransom_Note_Words {
    meta:
        description = "Detects common words used in ransomware ransom notes"
        author = "M4 Ahmed"
        category = "Ransomware"
        score = 25
    strings:
        $encrypted = "encrypted"
        $pay = "pay"
        $disk = "disk"
        $if = "if"
        $before = "before"
        $delete = "delete"
        $ransom = "ransom"
        $bitcoin = "bitcoin"
        $decrypt = "decrypt"
    condition:
        any of them
}


rule Detect_Multiple_File_Extensions {
    meta:
        description = "Detects executables referencing multiple file extensions"
        author = "M4 Ahmed"
        category = "Ransomware"
        score = 15
    strings:
        $txt = ".txt"
        $jpg = ".jpg"
        $pdf = ".pdf"
        $png = ".png"
        $html = ".html"
        $docx = ".docx"
        $xlsx = ".xlsx"
        $pptx = ".pptx"
        $zip = ".zip"
        $rar = ".rar"
    condition:
        #txt + #jpg + #pdf + #png + #html + #docx + #xlsx + #pptx + #zip + #rar > 5
}

rule Detect_Crypto_Constants {
    meta:
        description = "Detects RSA public key blobs or AES S-box constants"
        author = "M4 Ahmed"
        category = "Ransomware"
        score = 30
    strings:
        $rsa_key = { 30 82 ?? ?? 02 82 ?? ?? 00 82 ?? ?? 02 82 ?? ?? }
        $aes_sbox = { 63 7C 77 7B F2 6B 6F C5 30 01 67 2B FE D7 AB 76 }
    condition:
        any of them
}

rule Detect_Weird_File_Extensions {
    meta:
        description = "Detects executables referencing weird file extensions"
        author = "M4 Ahmed"
        category = "Ransomware"
        score = 20
    strings:
        $encrypted = ".encrypted"
        $locked = ".locked"
        $payforunlock = ".payforunlock"
        $fun = ".fun"
        $ransom = ".ransom"
        $crypt = ".crypt"
        $enc = ".enc"
    condition:
        any of them
}